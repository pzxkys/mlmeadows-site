name: Process Daily Photo
on:
  push:
    paths:
      - 'uploads/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ImageMagick
        run: sudo apt-get install -y imagemagick

      - name: Process Image, Timestamp, and Cache Buster
        run: |
          # 1. Rotate archives
          mv photo3.jpg photo4.jpg || true
          mv photo2.jpg photo3.jpg || true
          mv photo1.jpg photo2.jpg || true
          mv daily.jpg photo1.jpg || true
          
          # 2. Convert new upload
          NEW_FILE=$(ls -t uploads/ | head -1)
          convert "uploads/$NEW_FILE" -quality 80 daily.jpg
          rm "uploads/$NEW_FILE"
          
          # 3. Robust Timestamp & Cache Buster
          # This uses a different separator (@) to avoid issues with slashes
          TIMESTAMP=$(date +'%b %d, %Y - %I:%M %p')
          CACHE_ID=$(date +%s)
          
          sed -i "s@id=\"update-time\">.*</span>@id=\"update-time\">$TIMESTAMP</span>@g" index.html
          sed -i "s@daily.jpg?v=[0-9]*@daily.jpg?v=$CACHE_ID@g" index.html

          
          # 4. Update Cache Buster (changes ?v=1 to ?v=[current seconds])
          CACHE_ID=$(date +%s)
          sed -i "s/daily.jpg?v=[0-9]*/daily.jpg?v=$CACHE_ID/g" index.html

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Automated update: Image processed and cache busted"
          git push
